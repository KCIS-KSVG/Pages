<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KSVG | 项目进展</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poppins:wght@700&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="icon" href="https://raw.githubusercontent.com/KCIS-KSVG/Data/main/embed/ksvg-logo.png" type="image/png">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/KCIS-KSVG/Pages@main/css/navigator.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/KCIS-KSVG/Pages@main/css/footer.css">

    <style>
        :root {
            --primary-color: #920783;
            --secondary-color: #007bff;
            --dark-gray: #1d1d1f;
            --medium-gray: #424245;
            --light-gray: #f5f5f7;
            --text-color: #1d1d1f;
            --header-height: 70px;
            --status-ongoing-bg: #e6f7ff;
            --status-ongoing-text: #006d9c;
            --status-completed-bg: #f6ffed;
            --status-completed-text: #389e0d;
            --status-archived-bg: #fafafa;
            --status-archived-text: #8c8c8c;
            --status-planned-bg: #f0f5ff;
            --status-planned-text: #2f54eb;
            --status-cancelled-bg: #fff1f0;
            --status-cancelled-text: #cf1322;
        }

        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--light-gray);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        body.no-scroll {
            overflow: hidden;
        }

        a {
            text-decoration: none;
            color: inherit;
        }

        main {
            padding-top: var(--header-height);
            flex-grow: 1;
        }

        .page-intro {
            padding: 60px 30px;
            background-color: #fff;
            border-bottom: 1px solid #e0e0e0;
        }

        .page-container {
            max-width: 1280px;
            margin: 0 auto;
        }

        .page-intro h1 {
            font-family: 'Poppins', sans-serif;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .page-intro p {
            font-size: 1.1rem;
            color: var(--medium-gray);
            max-width: 800px;
        }

        .content-section {
            padding: 40px 30px 60px;
        }

        .controls-wrapper {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }

        .main-controls {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 20px;
        }

        .left-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background-color: #fff;
            border: 1px solid #d9d9d9;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .filter-btn.active {
            background-color: var(--primary-color);
            color: #fff;
            border-color: var(--primary-color);
        }

        .right-controls {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 15px;
        }

        .search-controls {
            display: flex;
        }

        .search-input {
            border: 1px solid #d9d9d9;
            padding: 10px 16px;
            border-radius: 8px 0 0 8px;
            font-size: 1rem;
            width: 300px;
            border-right: none;
            outline: none;
        }

        .search-button {
            background-color: var(--primary-color);
            color: #fff;
            border: 1px solid var(--primary-color);
            padding: 0 16px;
            border-radius: 0 8px 8px 0;
            font-size: 1.2rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
        }

        .search-button:hover {
            background-color: #7a066e;
        }

        .action-button {
            background-color: #fff;
            border: 1px solid #d9d9d9;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .action-button:hover {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .table-container {
            position: relative;
            background-color: #fff;
            border-radius: 8px;
            overflow-x: auto;
            border: 1px solid #e0e0e0;
            min-height: 300px;
        }

        #loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(5px);
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.3s;
            opacity: 0;
            pointer-events: none;
        }

        #loading-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .loader {
            border: 7px solid #f3f3f3;
            border-top: 7px solid var(--primary-color);
            border-radius: 50%;
            width: 70px;
            height: 70px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .project-table {
            width: 100%;
            min-width: 1000px;
            border-collapse: collapse;
        }

        .project-table th {
            position: sticky;
            top: 0;
            background-color: #fafafa;
            z-index: 1;
        }

        .sortable-header {
            cursor: pointer;
            user-select: none;
        }

        .sortable-header:hover {
            background-color: #f0f0f0;
        }

        .sort-indicator {
            display: inline-block;
            width: 1em;
            opacity: 0.5;
            font-size: 0.8em;
            margin-left: 5px;
            color: var(--dark-gray);
        }

        .sortable-header.sort-asc .sort-indicator,
        .sortable-header.sort-desc .sort-indicator {
            opacity: 1;
        }

        .project-table th,
        .project-table td {
            padding: 10px 15px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            vertical-align: middle;
            font-size: 0.9rem;
        }

        #match-details-header,
        .match-details-cell {
            display: none;
        }

        .project-table.is-searching #match-details-header,
        .project-table.is-searching .match-details-cell {
            display: table-cell;
        }

        .project-row {
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .project-row:hover {
            background-color: #f9f9f9;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-计划,
        .status-计划中 {
            background-color: var(--status-planned-bg);
            color: var(--status-planned-text);
        }

        .status-进行,
        .status-进行中 {
            background-color: var(--status-ongoing-bg);
            color: var(--status-ongoing-text);
        }

        .status-完成,
        .status-结束,
        .status-已完成,
        .status-提交完成 {
            background-color: var(--status-completed-bg);
            color: var(--status-completed-text);
        }

        .status-归档 {
            background-color: var(--status-archived-bg);
            color: var(--status-archived-text);
        }

        .status-取消 {
            background-color: var(--status-cancelled-bg);
            color: var(--status-cancelled-text);
        }

        mark.highlight {
            background-color: #fff38a;
            color: #000;
            padding: 2px;
            border-radius: 2px;
        }

        .match-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-right: 5px;
            margin-bottom: 5px;
        }

        .match-badge-project {
            background-color: #e6f7ff;
            color: #1890ff;
        }

        .match-badge-session {
            background-color: #f6ffed;
            color: #52c41a;
        }

        .match-badge-product {
            background-color: #fffbe6;
            color: #faad14;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(29, 29, 31, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s cubic-bezier(0.23, 1, 0.32, 1);
        }

        .modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        #request-modal {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #request-modal .modal-content {
            background: #fff;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            padding: 30px;
            display: flex;
            flex-direction: column;
            max-height: 85vh;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.4s cubic-bezier(0.23, 1, 0.32, 1), opacity 0.4s cubic-bezier(0.23, 1, 0.32, 1);
        }

        #request-modal.visible .modal-content {
            transform: scale(1);
            opacity: 1;
        }

        #details-modal {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #details-modal .modal-content {
            position: relative;
            width: 90%;
            max-width: 1200px;
            height: 90vh;
            background: var(--light-gray);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.4s cubic-bezier(0.23, 1, 0.32, 1), opacity 0.4s cubic-bezier(0.23, 1, 0.32, 1);
        }

        #details-modal.visible .modal-content {
            transform: scale(1);
            opacity: 1;
        }

        .modal-header {
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid #ddd;
        }

        .modal-header .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .modal-header .header-actions {
            display: flex;
            gap: 15px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--medium-gray);
        }

        .modal-body {
            flex-grow: 1;
            overflow-y: auto;
            padding: 25px;
        }

        .detail-card {
            background: #fff;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            margin-bottom: 20px;
        }

        .detail-card h3 {
            font-size: 1.2rem;
            padding: 15px 20px;
            border-bottom: 1px solid #e8e8e8;
        }

        .detail-card-body {
            padding: 20px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px 30px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-item .label {
            font-size: 0.9rem;
            color: var(--medium-gray);
            font-weight: 600;
            margin-bottom: 5px;
        }

        .detail-item .value {
            font-size: 1rem;
            color: var(--dark-gray);
            word-break: break-all;
        }

        .detail-item .value.description {
            white-space: pre-wrap;
            line-height: 1.7;
            grid-column: 1 / -1;
        }

        .section-divider {
            border: none;
            border-top: 1px solid #eee;
            margin: 20px 0;
        }

        .session-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .session-header {
            background: #fafafa;
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
            border-radius: 8px 8px 0 0;
        }

        .session-header h4 {
            font-size: 1.2rem;
            margin: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .session-body {
            padding: 20px;
        }

        .session-body h5 {
            font-size: 1rem;
            margin-top: 20px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }

        .session-body h5:first-child {
            margin-top: 0;
        }

        .details-table-wrapper {
            overflow-x: auto;
            border: 1px solid #e8e8e8;
            border-radius: 6px;
        }

        .details-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .details-table th,
        .details-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
            white-space: nowrap;
            border-right: 1px solid #f0f0f0;
        }

        .details-table th:last-child,
        .details-table td:last-child {
            border-right: none;
        }

        .details-table th {
            background: #f9f9f9;
        }

        .details-table tr:last-child td {
            border-bottom: none;
        }

        .no-data {
            color: var(--medium-gray);
            padding: 20px;
            text-align: center;
        }

        .modal-page {
            display: none;
        }

        .modal-page.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group .readonly-field {
            background: #f0f0f0;
            cursor: not-allowed;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .selection-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
        }

        .selection-item label {
            font-weight: normal;
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .selection-item input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
        }

        .selection-item-project {
            font-weight: bold;
        }

        .selection-item-session {
            padding-left: 25px;
        }

        .selection-item-product {
            padding-left: 25px;
            color: #555;
        }

        .selection-item.disabled>label {
            color: #ccc;
            cursor: not-allowed;
        }

        .selection-rule {
            font-size: 0.9rem;
            color: var(--medium-gray);
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .word-counter {
            text-align: right;
            font-size: 0.85rem;
            color: var(--medium-gray);
        }

        .warning-text {
            color: #c81e1e;
            font-weight: 600;
            background-color: #fff1f0;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .warning-text p {
            margin: 0 0 10px 0;
        }

        .warning-text p:last-child {
            margin-bottom: 0;
        }

        .email-fallback {
            font-size: 0.85rem;
            color: var(--secondary-color);
            text-align: center;
            margin-bottom: 20px;
        }

        .email-fallback a {
            font-weight: 600;
            text-decoration: underline;
        }

        .feedback-page {
            text-align: center;
            padding: 40px;
        }

        .feedback-page i {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .feedback-page.success i {
            color: #389e0d;
        }

        .feedback-page.error i {
            color: #cf1322;
        }

        .feedback-page h3 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .feedback-page p {
            color: var(--medium-gray);
        }

        .modal-footer {
            flex-shrink: 0;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            border-top: 1px solid #eee;
            padding-top: 20px;
            margin-top: 20px;
        }

        .modal-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 18px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s ease;
        }

        .modal-button-primary {
            background: var(--primary-color);
            color: #fff;
        }

        .modal-button-primary:hover {
            background: #7a066e;
        }

        .modal-button-secondary {
            background: #eee;
            border-color: #ddd;
        }

        .modal-button-secondary:hover {
            background: #ddd;
        }

        .modal-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .content-section {
                padding: 20px 15px 40px;
            }

            .page-intro {
                padding: 40px 15px;
            }

            .page-intro h1 {
                font-size: 2rem;
            }

            .page-intro p {
                font-size: 1rem;
            }

            .project-table th,
            .project-table td {
                padding: 8px 10px;
                font-size: 0.85rem;
                white-space: normal;
            }

            .status-badge {
                padding: 3px 8px;
                font-size: 0.75rem;
            }

            #details-modal .modal-content {
                width: 100%;
                height: 100vh;
                top: 0;
                border-radius: 0;
            }

            #details-modal .modal-body {
                padding: 15px;
            }

            #details-modal .modal-header {
                padding: 15px;
            }

            #details-modal .modal-header h2 {
                font-size: 1.2rem;
            }

            .detail-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px 10px;
            }

            .detail-item .label {
                font-size: 0.8rem;
            }

            .detail-item .value {
                font-size: 0.9rem;
            }

            .details-table {
                font-size: 0.8rem;
            }

            .details-table th,
            .details-table td {
                padding: 6px;
                white-space: normal;
            }

            .details-table th:last-child,
            .details-table td:last-child {
                border-right: 1px solid #f0f0f0;
            }

            #request-modal .modal-content {
                padding: 20px;
                max-height: 95vh;
            }

            #request-modal .modal-body {
                font-size: 0.9rem;
            }

            .form-group label {
                font-size: 0.9rem;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 0.9rem;
                padding: 8px;
            }

            .main-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 25px;
            }

            .left-controls,
            .right-controls {
                align-items: stretch;
                width: 100%;
            }

            .search-controls {
                width: 100%;
            }

            .search-input {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <header class="site-header">
        <nav class="navigation">
            <a href="https://ksvg.com.cn/" class="logo-link"><img
                    src="https://raw.githubusercontent.com/KCIS-KSVG/Data/main/embed/ksvg-logo.png" alt="KSVG Logo"
                    class="logo-image"></a>
            <ul class="nav-menu">
                <li><a href="https://ksvg.com.cn/">主页</a></li>
                <li><a href="https://ksvg.com.cn/progress/" class="active">项目进展</a></li>
                <li><a href="https://ksvg.com.cn/media/">媒体共享</a></li>
                <li><a href="https://ksvg.com.cn/documentation/">文件共享</a></li>
                <li><a href="https://ksvg.com.cn/schedule/">日程信息</a></li>
                <li><a href="https://ksvg.com.cn/recruiting/">组织招募</a></li>
            </ul>
            <button class="nav-toggle" aria-label="Open menu"><i class="ri-menu-line"></i></button>
        </nav>
    </header>

    <main>
        <section class="page-intro">
            <div class="page-container">
                <h1>项目进展</h1>
                <p>在此查询所有已备案项目的当前状态、执行详情及历史记录。点击项目行可弹出详情窗口。</p>
            </div>
        </section>
        <section class="content-section">
            <div class="page-container">
                <div class="controls-wrapper">
                    <div class="main-controls">
                        <div class="left-controls">
                            <div class="filter-controls">
                                <button class="filter-btn active" data-filter="all">所有项目</button>
                                <button class="filter-btn" data-filter="计划">计划</button>
                                <button class="filter-btn" data-filter="进行">进行</button>
                                <button class="filter-btn" data-filter="结束">结束</button>
                            </div>
                        </div>
                        <div class="right-controls">
                            <div class="search-controls">
                                <input type="search" class="search-input" id="search-input" placeholder="键入关键词以搜索...">
                                <button class="search-button" id="search-button"><i class="ri-search-line"></i></button>
                            </div>
                            <button class="action-button" id="new-request-button"><i class="ri-mail-add-line"></i>
                                新增事件或请求</button>
                        </div>
                    </div>
                </div>
                <div class="table-container" id="table-area">
                    <div id="loading-overlay">
                        <div class="loader"></div>
                    </div>
                    <table class="project-table">
                        <thead>
                            <tr>
                                <th class="sortable-header" data-sort="项目注册名称">项目名称 <span class="sort-indicator"></span>
                                </th>
                                <th class="sortable-header" data-sort="项目编码">内部编号 <span class="sort-indicator"></span>
                                </th>
                                <th class="sortable-header" data-sort="项目开始日期">开始日期 <span class="sort-indicator"></span>
                                </th>
                                <th class="sortable-header" data-sort="项目结束日期">结束日期 <span class="sort-indicator"></span>
                                </th>
                                <th class="sortable-header" data-sort="对接部门和组织">合作部门 <span
                                        class="sort-indicator"></span></th>
                                <th class="sortable-header" data-sort="状态项目">状态 <span class="sort-indicator"></span>
                                </th>
                                <th id="match-details-header" style="min-width: 150px;">搜索匹配</th>
                            </tr>
                        </thead>
                        <tbody id="project-table-body"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <div class="modal-overlay" id="details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="header-left">
                    <h2 id="details-modal-title"></h2>
                </div>
                <div class="header-actions">
                    <button class="modal-button modal-button-secondary" id="details-modal-print-button"><i
                            class="ri-printer-line"></i>输出</button>
                    <button class="modal-close" id="details-modal-close-button"><i class="ri-close-line"></i></button>
                </div>
            </div>
            <div class="modal-body" id="details-modal-body"></div>
        </div>
    </div>

    <div class="modal-overlay" id="request-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">新增事件或请求 (1/4)</h2>
                <button class="modal-close" id="modal-close-button"><i class="ri-close-line"></i></button>
            </div>
            <div class="modal-body">
                <div class="modal-page active" id="modal-page-1">
                    <div class="form-group">
                        <label>选择关联项目/场次/产品</label>
                        <p class="selection-rule">注意：一次只能提交与单个项目（Project）相关的事件或请求。</p>
                        <div class="selection-list" id="modal-selection-list"></div>
                    </div>
                </div>
                <div class="modal-page" id="modal-page-2">
                    <div class="form-group"><label>事件编号</label><input type="text" id="modal-request-id"
                            class="readonly-field" readonly></div>
                    <div class="form-group"><label>关联信息</label><textarea id="modal-selected-item" class="readonly-field"
                            readonly rows="2"></textarea></div>
                    <div class="form-group"><label for="modal-category">事件类别</label><select id="modal-category">
                            <option value="服务反馈">服务反馈</option>
                            <option value="加急请求">加急请求</option>
                            <option value="状态请求">状态请求</option>
                            <option value="变更信息">变更信息</option>
                            <option value="其他类别">其他类别</option>
                        </select></div>
                    <div class="form-group"><label for="modal-description">具体描述</label><textarea id="modal-description"
                            placeholder="请详细描述您的请求 (5-200字)"></textarea>
                        <div class="word-counter" id="word-counter">0/200</div>
                    </div>
                </div>
                <div class="modal-page" id="modal-page-3">
                    <p class="email-fallback">本表单仅支持境外网络环境提交数据。如果您无法访问，<a href="#"
                            id="email-fallback-link">请点此处通过邮箱发送信息</a>。</p>
                    <div class="warning-text">
                        <p><strong>注意事项：</strong></p>
                        <p>1. 请确保您提交的信息真实有效。禁止提交不当言论或滥用此系统。</p>
                        <p>2. 请勿代他人提交或泄露他人个人信息。</p>
                        <p>3. 我们承诺将严格保护您的个人数据，并仅将其用于本次事件处理。您的数据被安全的储存在Google。</p>
                    </div>
                    <div class="form-grid">
                        <div class="form-group"><label for="modal-name">姓名</label><input type="text" id="modal-name"
                                required></div>
                        <div class="form-group"><label for="modal-fillerId">学号/工号 (ID)</label><input type="text"
                                id="modal-fillerId" required></div>
                    </div>
                    <div class="form-group"><label for="modal-unit">母班级/部门/组织</label><input type="text" id="modal-unit"
                            required></div>
                </div>
                <div class="modal-page" id="modal-page-4">
                    <div class="feedback-page success" id="feedback-success" style="display: none;">
                        <i class="ri-checkbox-circle-line"></i>
                        <h3>提交成功</h3>
                        <p>感谢您的反馈，我们会尽快处理。</p>
                    </div>
                    <div class="feedback-page error" id="feedback-error" style="display: none;">
                        <i class="ri-error-warning-line"></i>
                        <h3>提交失败</h3>
                        <p>网络或服务器发生错误，请稍后重试。</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-button modal-button-secondary" id="modal-back-button"
                    style="display: none;">返回</button>
                <button class="modal-button modal-button-primary" id="modal-next-button" disabled>继续</button>
                <button class="modal-button modal-button-primary" id="modal-submit-button" style="display: none;"
                    disabled>提交</button>
                <button class="modal-button modal-button-secondary" id="modal-close-final-button"
                    style="display: none;">关闭</button>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-container">
            <div class="footer-left">
                <p>© 2025 TonyJian-KSVG. All Rights Reserved.</p>
                <div class="footer-socials">
                    <a href="https://space.bilibili.com/23855258?spm_id_from=333.1007.0.0" aria-label="Bilibili"
                        title="Bilibili"><i class="ri-bilibili-fill"></i></a>
                    <a href="https://www.youtube.com/@kcisec-ksvg" aria-label="YouTube" title="YouTube"><i
                            class="ri-youtube-fill"></i></a>
                    <a href="mailto:support_ksvg@163.com" aria-label="Email" title="Email"><i
                            class="ri-mail-line"></i></a>
                </div>
            </div>
            <div class="footer-address">
                <p>Kang Chiao International School East China</p>
                <p>No.500, Xihuan Road, Huaqiao Economic Development Zone, Kunshan, Jiangsu</p>
            </div>
        </div>
    </footer>
    <script>
        try {
            document.addEventListener("DOMContentLoaded", function () {
                const navToggle = document.querySelector('.nav-toggle'); const navMenu = document.querySelector('.nav-menu'); const body = document.body;
                if (navToggle && navMenu) {
                    const icon = navToggle.querySelector('i');
                    const toggleMenu = (forceClose = false) => {
                        const isActive = navMenu.classList.contains('is-active');
                        if (forceClose || isActive) {
                            navMenu.classList.remove('is-active'); navToggle.classList.remove('is-active');
                            body.classList.remove('no-scroll'); icon.className = 'ri-menu-line';
                        } else {
                            navMenu.classList.add('is-active'); navToggle.classList.add('is-active');
                            body.classList.add('no-scroll'); icon.className = 'ri-close-line';
                        }
                    };
                    navToggle.addEventListener('click', () => toggleMenu());
                    const navLinks = navMenu.querySelectorAll('a');
                    navLinks.forEach(link => { link.addEventListener('click', () => { setTimeout(() => toggleMenu(true), 100); }); });
                }

                const BASE_URL = 'https://raw.githubusercontent.com/KCIS-KSVG/Data/main/progress/';
                const URLS = {
                    projects: `${BASE_URL}01.csv`, sessions: `${BASE_URL}02.csv`,
                    setups: `${BASE_URL}03.csv`, products: `${BASE_URL}04.csv`,
                    staff: `${BASE_URL}05.csv`, equipment: `${BASE_URL}06.csv`
                };
                const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzC5cFEo7_tHSG5mKpSJU91eEmIOta4--bYg7ta5fRG8MpXOIaSyV63ocYi5zPnRrE/exec";

                let allData = []; let currentFilter = 'all'; let currentSort = { key: '项目编码', order: 'asc' };
                const ui = {
                    loadingOverlay: document.getElementById('loading-overlay'), tableBody: document.getElementById('project-table-body'), table: document.querySelector('.project-table'),
                    tableHead: document.querySelector('.project-table thead'),
                    searchInput: document.getElementById('search-input'), searchButton: document.getElementById('search-button'), filterBtns: document.querySelectorAll('.filter-btn')
                };

                const detailsModal = {
                    overlay: document.getElementById('details-modal'), title: document.getElementById('details-modal-title'),
                    body: document.getElementById('details-modal-body'), closeBtn: document.getElementById('details-modal-close-button'),
                    printBtn: document.getElementById('details-modal-print-button'), currentProjectId: null,
                    open(projectId) {
                        const project = allData.find(p => p['项目编码'] === projectId); if (!project) return;
                        this.currentProjectId = project['项目编码']; this.title.textContent = project['项目注册名称'];
                        this.body.innerHTML = this.generateContent(project);
                        this.overlay.classList.add('visible'); body.classList.add('no-scroll');
                    },
                    close() { this.overlay.classList.remove('visible'); body.classList.remove('no-scroll'); },

                    generateContent(p) {
                        const searchTerm = ui.searchInput.value.toLowerCase().trim();
                        const createDetailItem = (label, value) => value || value === 0 ? `<div class="detail-item"><div class="label">${label}</div><div class="value">${value}</div></div>` : '';
                        const createDescriptionItem = (label, value) => value ? `<div class="detail-item value description"><div class="label">${label}</div>${highlight(value, searchTerm)}</div>` : '';
                        const driveLink = p['云端硬盘文稿库'];
                        const driveLinkHTML = driveLink ? `<a href="${driveLink}" target="_blank" style="text-decoration: underline;">点此查看</a>` : '无';

                        const projectDetails = `<div class="detail-card">
                            <h3>项目详情</h3>
                            <div class="detail-card-body">
                                <div class="detail-grid">
                                    ${createDetailItem('内部编号', highlight(p['项目编码'], searchTerm))}
                                    ${createDetailItem('合作部门', highlight(p['对接部门和组织'], searchTerm))}
                                    ${createDetailItem('状态', `<span class="status-badge status-${p['状态项目']}">${p['状态项目']}</span>`)}
                                    ${createDetailItem('开始日期', formatDateString(p['项目开始日期']))}
                                    ${createDetailItem('结束日期', formatDateString(p['项目结束日期']))}
                                    ${createDetailItem('项目负责人', highlight(p['项目负责人'], searchTerm))}
                                </div>
                                <hr class="section-divider">
                                <div class="detail-grid">
                                    ${createDetailItem('全局视频规格', highlight(p['全局视频规格'], searchTerm))}
                                    ${createDetailItem('全局照片规格', highlight(p['全局照片规格'], searchTerm))}
                                    ${createDetailItem('本地媒体备份', highlight(p['本地媒体备份'], searchTerm))}
                                    ${createDetailItem('云端媒体备份', highlight(p['云端媒体备份'], searchTerm))}
                                    ${createDetailItem('云端硬盘文稿库', driveLinkHTML)}
                                </div>
                                ${createDescriptionItem('项目备注', p['备注'])}
                            </div>
                        </div>`;

                        const productRequests = p.products && p.products.length > 0 ? `<div class="detail-card"><h3>产品请求</h3><div class="detail-card-body" style="padding:0;">
                        <div class="details-table-wrapper"><table class="details-table"><thead><tr><th>编号</th><th>类别</th><th>名称/描述</th><th>负责人</th><th>状态</th><th>备注</th></tr></thead><tbody>
                        ${p.products.map(pr => `<tr>
                            <td>${highlight(pr['产品编码'], searchTerm)}</td>
                            <td>${highlight(pr['分类'], searchTerm)}</td>
                            <td style="white-space:normal;">${highlight(pr['需求描述'], searchTerm)}</td>
                            <td>${highlight(pr['负责人'], searchTerm)}</td>
                            <td><span class="status-badge status-${pr['状态']}">${pr['状态']}</span></td>
                            <td style="white-space:normal;">${highlight(pr['备注'], searchTerm)}</td>
                        </tr>`).join('')}
                        </tbody></table></div></div></div>` : '';

                        const sessions = p.sessions && p.sessions.length > 0 ? `<div class="detail-card"><h3>归属场次</h3><div class="detail-card-body">
                            ${p.sessions.map(s => {
                            const startDate = formatDateString(s['场次开始时间'], true);
                            const endDate = formatDateString(s['场次结束时间'], true);
                            const dateHTML = startDate === 'N/A' && endDate === 'N/A' ? 'N/A' : `起始：${startDate}<br>结束：${endDate}`;

                            const setupsHTML = `<h5>机位编组</h5>` + (s.setups && s.setups.length > 0
                                ? `<div class="details-table-wrapper"><table class="details-table">
                                        <thead><tr><th>机位</th><th>描述</th><th>负责人</th><th style="width: 40%;">设备</th><th>备注</th></tr></thead>
                                        <tbody>
                                            ${s.setups.map(setup => `<tr>
                                                <td>${highlight(setup['机位序号'], searchTerm)}</td>
                                                <td>${highlight(setup['机位描述'], searchTerm)}</td>
                                                <td>${highlight(setup.staff?.['NAME'], searchTerm) || 'N/A'}</td>
                                                <td style="white-space:normal;">${highlight(setup.equipment?.['型号'], searchTerm) || 'N/A'}</td>
                                                <td style="white-space:normal;">${highlight(setup['备注'], searchTerm)}</td>
                                            </tr>`).join('')}
                                        </tbody>
                                    </table></div>`
                                : '<div class="no-data">无机位编组信息</div>');

                            return `<div class="session-card">
                                <div class="session-header"><h4>${highlight(s['场次名称'], searchTerm)} (${highlight(s['场次序号'], searchTerm)}) <span class="status-badge status-${s['场次状态']}">${highlight(s['场次状态'], searchTerm)}</span></h4></div>
                                <div class="session-body">
                                    <div class="detail-grid" style="grid-template-columns: repeat(2, 1fr); margin-bottom: 20px;">
                                        ${createDetailItem('场地', highlight(s['执行地点'], searchTerm))}
                                        ${createDetailItem('日期', dateHTML)}
                                        ${createDescriptionItem('备注', s['场次备注'])}
                                    </div>
                                    ${setupsHTML}
                                </div></div>`
                        }).join('')}
                        </div></div>`: '';

                        return projectDetails + productRequests + sessions;
                    }
                };

                function parseCSV(text) {
                    if (!text) return [];
                    const lines = text.trim().replace(/^\uFEFF/, "").split(/\r?\n/);
                    if (lines.length < 2) return [];
                    const headers = lines[0].split(',').map(h => h.trim());

                    const splitCsvLine = (line) => {
                        const result = [];
                        let current = '';
                        let inQuotes = false;
                        for (const char of line) {
                            if (char === '"') {
                                inQuotes = !inQuotes;
                            } else if (char === ',' && !inQuotes) {
                                result.push(current);
                                current = '';
                            } else {
                                current += char;
                            }
                        }
                        result.push(current);
                        return result;
                    };

                    return lines.slice(1).map(line => {
                        const values = splitCsvLine(line);
                        return headers.reduce((obj, header, index) => {
                            obj[header] = (values[index] || '').trim();
                            return obj;
                        }, {});
                    });
                }
                async function fetchCSV(url) { const response = await fetch(`${url}?v=${new Date().getTime()}`); if (!response.ok) throw new Error(`Failed to fetch ${url}: ${response.statusText}`); return await response.text(); }

                async function loadAllData() {
                    ui.loadingOverlay.classList.add('visible');
                    try {
                        const results = await Promise.allSettled(Object.values(URLS).map(fetchCSV));
                        const [projects, sessions, setups, products, staff, equipment] = results.map(res => res.status === 'fulfilled' ? parseCSV(res.value) : []);
                        if (!projects || projects.length === 0) throw new Error("Critical file '01.csv' failed to load.");

                        allData = projects.map(p => {
                            const projectProducts = products.filter(pr => pr['项目编码（自动）'] === p['项目编码']);
                            const projectSessions = sessions.filter(s => s['项目编码（自动）'] === p['项目编码']).map(session => {
                                const sessionSetups = setups.filter(setup => setup['场次归属（关联）'] === session['场次名称'])
                                    .map(setup => {
                                        const staffDetails = staff.find(s => s['NAME'] === setup['人员配置']);
                                        const equipDetails = equipment.find(e => e['型号'] === setup['设备配置']);
                                        return { ...setup, staff: staffDetails, equipment: equipDetails };
                                    });
                                return { ...session, setups: sessionSetups };
                            });
                            return { ...p, sessions: projectSessions, products: projectProducts };
                        });

                        applyFiltersAndSearch();

                        const params = new URLSearchParams(window.location.search);
                        const projectIdToOpen = params.get('open');
                        if (projectIdToOpen) {
                            if (allData.some(p => p['项目编码'] === projectIdToOpen || `PRJ-${p['项目编码']}` === projectIdToOpen)) {
                                detailsModal.open(projectIdToOpen.replace('PRJ-', ''));
                            } else {
                                console.warn(`Project ID "${projectIdToOpen}" from URL not found.`);
                            }
                            const newUrl = window.location.pathname;
                            history.replaceState({}, '', newUrl);
                        }
                    } catch (error) { console.error('Data loading or processing failed:', error); ui.tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 40px; color: red;">数据加载失败: ${error.message}</td></tr>`; } finally { ui.loadingOverlay.classList.remove('visible'); }
                }

                function formatDateString(dateStr, includeTime = false) {
                    if (!dateStr || dateStr.toLowerCase() === 'n/a') return 'N/A';
                    if (includeTime) {
                        let match = dateStr.match(/(\d{4})年\s*(\d{1,2})月\s*(\d{1,2})日\s*(\d{1,2}):(\d{2})/);
                        if (match) {
                            const [, year, month, day, hour, minute] = match;
                            return `${year}年${month.padStart(2, '0')}月${day.padStart(2, '0')}日 ${hour.padStart(2, '0')}时${minute}分`;
                        }
                    }
                    let match = dateStr.match(/(\d{4})年\s*(\d{1,2})月\s*(\d{1,2})日/);
                    if (match) {
                        const [, year, month, day] = match;
                        return `${year}年${month.padStart(2, '0')}月${day.padStart(2, '0')}日`;
                    }
                    return dateStr;
                }

                function highlight(text, term) { if (!term || !text) return text; return text.toString().replace(new RegExp(term.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'gi'), match => `<mark class="highlight">${match}</mark>`); }

                function renderTable(data, searchTerm = '') {
                    data.sort((a, b) => { const valA = a[currentSort.key]; const valB = b[currentSort.key]; let comparison = String(valA).localeCompare(String(valB), undefined, { numeric: true }); return currentSort.order === 'asc' ? comparison : -comparison; });
                    ui.tableHead.querySelectorAll('.sortable-header').forEach(th => { th.classList.remove('sort-asc', 'sort-desc'); const indicator = th.querySelector('.sort-indicator'); if (th.dataset.sort === currentSort.key) { th.classList.add(`sort-${currentSort.order}`); indicator.textContent = currentSort.order === 'asc' ? '▲' : '▼'; } else { indicator.textContent = ''; } });
                    ui.tableBody.innerHTML = ''; if (data.length === 0) { ui.tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 40px;">未找到匹配的项目。</td></tr>`; return; }
                    data.forEach(p => {
                        const projectRow = document.createElement('tr');
                        projectRow.className = 'project-row'; projectRow.dataset.id = p['项目编码'];
                        let matchDetailsHTML = '';
                        if (searchTerm) {
                            if (p.projectMatchCount > 0) matchDetailsHTML += `<span class="match-badge match-badge-project">项目匹配: ${p.projectMatchCount}</span>`;
                            if (p.sessionMatchCount > 0) matchDetailsHTML += `<span class="match-badge match-badge-session">场次匹配: ${p.sessionMatchCount}</span>`;
                            if (p.productMatchCount > 0) matchDetailsHTML += `<span class="match-badge match-badge-product">产品匹配: ${p.productMatchCount}</span>`;
                        }
                        projectRow.innerHTML = `<td>${highlight(p['项目注册名称'], searchTerm)}</td><td>${highlight(p['项目编码'], searchTerm)}</td><td>${formatDateString(p['项目开始日期'])}</td><td>${formatDateString(p['项目结束日期'])}</td><td>${highlight(p['对接部门和组织'], searchTerm)}</td><td><span class="status-badge status-${p['状态项目']}">${p['状态项目']}</span></td><td class="match-details-cell">${matchDetailsHTML}</td>`;
                        ui.tableBody.appendChild(projectRow);
                    });
                }

                function applyFiltersAndSearch() {
                    const searchTerm = ui.searchInput.value.toLowerCase().trim();
                    ui.table.classList.toggle('is-searching', !!searchTerm);
                    let filteredData = allData;
                    if (currentFilter !== 'all') { filteredData = filteredData.filter(p => p['状态项目'] === currentFilter); }
                    if (searchTerm) {
                        const searchRegex = new RegExp(searchTerm.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'gi');
                        const countMatches = (obj) => Object.values(obj).join(' ').toLowerCase().match(searchRegex)?.length || 0;

                        filteredData = filteredData.map(p => {
                            let projectMatchCount = countMatches({ name: p['项目注册名称'], id: p['项目编码'], department: p['对接部门和组织'], description: p['备注'] });
                            let productMatchCount = p.products.reduce((sum, pr) => sum + countMatches(pr), 0);
                            let sessionMatchCount = p.sessions.reduce((sum, s) => {
                                let count = countMatches({ name: s['场次名称'], id: s['场次序号'], site: s['执行地点'], notes: s['场次备注'] });
                                count += s.setups.reduce((setupSum, setup) => setupSum + countMatches(setup) + countMatches(setup.staff || {}) + countMatches(setup.equipment || {}), 0);
                                return sum + count;
                            }, 0);

                            return { ...p, projectMatchCount, sessionMatchCount, productMatchCount };
                        }).filter(p => p.projectMatchCount > 0 || p.sessionMatchCount > 0 || p.productMatchCount > 0);
                    }
                    renderTable(filteredData, searchTerm);
                }

                ui.searchButton.addEventListener('click', applyFiltersAndSearch);
                ui.searchInput.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); applyFiltersAndSearch(); } });

                ui.filterBtns.forEach(btn => btn.addEventListener('click', function () { ui.filterBtns.forEach(b => b.classList.remove('active')); this.classList.add('active'); currentFilter = this.dataset.filter; applyFiltersAndSearch(); }));
                ui.tableBody.addEventListener('click', e => { const row = e.target.closest('.project-row'); if (row) detailsModal.open(row.dataset.id); });
                detailsModal.closeBtn.addEventListener('click', () => detailsModal.close());
                detailsModal.overlay.addEventListener('click', (e) => { if (e.target === detailsModal.overlay) { detailsModal.close(); } });

                detailsModal.printBtn.addEventListener('click', () => {
                    if (detailsModal.currentProjectId) {
                        const url = `https://rendering.ksvg.com.cn/progress/?id=${detailsModal.currentProjectId}`;
                        window.location.href = url;
                    }
                });
                ui.tableHead.addEventListener('click', e => { const header = e.target.closest('.sortable-header'); if (!header) return; const sortKey = header.dataset.sort; if (currentSort.key === sortKey) { currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc'; } else { currentSort.key = sortKey; currentSort.order = 'asc'; } applyFiltersAndSearch(); });

                const requestFormModal = {
                    overlay: document.getElementById('request-modal'),
                    title: document.getElementById('modal-title'),
                    pages: document.querySelectorAll('#request-modal .modal-page'),
                    backBtn: document.getElementById('modal-back-button'),
                    nextBtn: document.getElementById('modal-next-button'),
                    submitBtn: document.getElementById('modal-submit-button'),
                    closeFinalBtn: document.getElementById('modal-close-final-button'),
                    closeBtn: document.querySelector('#request-modal .modal-close'),
                    emailFallbackLink: document.getElementById('email-fallback-link'),
                    selectionList: document.getElementById('modal-selection-list'),
                    requestIdInput: document.getElementById('modal-request-id'),
                    selectedItemInput: document.getElementById('modal-selected-item'),
                    categorySelect: document.getElementById('modal-category'),
                    descriptionText: document.getElementById('modal-description'),
                    wordCounter: document.getElementById('word-counter'),
                    nameInput: document.getElementById('modal-name'),
                    fillerIdInput: document.getElementById('modal-fillerId'),
                    unitInput: document.getElementById('modal-unit'),
                    feedbackSuccess: document.getElementById('feedback-success'),
                    feedbackError: document.getElementById('feedback-error'),
                    currentPage: 1, selectedItems: [],
                    open() { this.reset(); this.populateList(); this.overlay.classList.add('visible'); },
                    close() { this.overlay.classList.remove('visible'); },
                    reset() {
                        this.currentPage = 1; this.selectedItems = []; this.descriptionText.value = '';
                        this.categorySelect.value = '服务反馈'; this.nameInput.value = ''; this.fillerIdInput.value = ''; this.unitInput.value = '';
                        this.goToPage(1);
                    },
                    goToPage(pageNumber) {
                        this.currentPage = pageNumber;
                        this.pages.forEach((page, index) => page.classList.toggle('active', index + 1 === pageNumber));
                        this.title.textContent = `新增事件或请求 (${pageNumber}/4)`;
                        this.backBtn.style.display = (pageNumber > 1 && pageNumber < 4) ? 'inline-flex' : 'none';
                        this.nextBtn.style.display = (pageNumber < 3) ? 'inline-flex' : 'none';
                        this.submitBtn.style.display = (pageNumber === 3) ? 'inline-flex' : 'none';
                        this.closeFinalBtn.style.display = (pageNumber === 4) ? 'inline-flex' : 'none';
                        if (pageNumber === 4) { this.title.textContent = "提交状态"; this.backBtn.style.display = 'none'; }
                        this.updateFormState();
                    },
                    populateList() {
                        let html = '';
                        allData.forEach(p => {
                            html += `<div class="selection-item selection-item-project" data-project-id="${p['项目编码']}"><label><input type="checkbox" data-type="project" data-id="${p['项目编码']}"> ${p['项目注册名称']} (${p['项目编码']})</label></div>`;
                            p.products.forEach(pr => { html += `<div class="selection-item selection-item-product" data-project-id="${p['项目编码']}"><label><input type="checkbox" data-type="product" data-id="${pr['产品编码']}" data-parent-id="${p['项目编码']}"> ${pr['需求描述'].substring(0, 30)}... (${pr['产品编码']})</label></div>`; });
                            p.sessions.forEach(s => { html += `<div class="selection-item selection-item-session" data-project-id="${p['项目编码']}"><label><input type="checkbox" data-type="session" data-id="${s['场次名称']}" data-parent-id="${p['项目编码']}"> ${s['场次名称']} (${s['场次序号']})</label></div>`; });
                        });
                        this.selectionList.innerHTML = html;
                    },
                    handleSelectionChange(e) {
                        const checkbox = e.target;
                        if (!checkbox || checkbox.type !== 'checkbox') return;
                        const parentProjectDiv = checkbox.closest('.selection-item-project');
                        const currentProjectId = parentProjectDiv ? parentProjectDiv.dataset.projectId : checkbox.closest('.selection-item').dataset.projectId;
                        if (checkbox.dataset.type === 'project') {
                            const children = this.selectionList.querySelectorAll(`[data-parent-id="${checkbox.dataset.id}"]`);
                            children.forEach(child => child.checked = checkbox.checked);
                        } else {
                            const parentCheckbox = this.selectionList.querySelector(`input[data-type="project"][data-id="${checkbox.dataset.parentId}"]`);
                            if (parentCheckbox) {
                                const allChildren = this.selectionList.querySelectorAll(`[data-parent-id="${checkbox.dataset.parentId}"]`);
                                const allChildrenChecked = Array.from(allChildren).every(child => child.checked);
                                parentCheckbox.checked = allChildrenChecked;
                            }
                        }
                        const anyChecked = this.selectionList.querySelector('input:checked');
                        if (anyChecked) {
                            const selectedProjectId = anyChecked.closest('.selection-item').dataset.projectId;
                            this.selectionList.querySelectorAll('.selection-item').forEach(item => {
                                if (item.dataset.projectId !== selectedProjectId) {
                                    item.classList.add('disabled');
                                    item.querySelectorAll('input').forEach(input => input.disabled = true);
                                }
                            });
                        } else {
                            this.selectionList.querySelectorAll('.selection-item').forEach(item => {
                                item.classList.remove('disabled');
                                item.querySelectorAll('input').forEach(input => input.disabled = false);
                            });
                        }
                        this.updateFormState();
                    },
                    updateFormState() {
                        if (this.currentPage === 1) { this.selectedItems = Array.from(this.selectionList.querySelectorAll('input:checked')).map(cb => ({ id: cb.dataset.id, type: cb.dataset.type, parent: cb.dataset.parentId })); this.nextBtn.disabled = this.selectedItems.length === 0; }
                        else if (this.currentPage === 2) { const descLength = this.descriptionText.value.trim().length; this.wordCounter.textContent = `${descLength}/200`; this.nextBtn.disabled = !(descLength >= 5 && descLength <= 200); }
                        else if (this.currentPage === 3) { this.submitBtn.disabled = !(this.nameInput.value.trim() && this.fillerIdInput.value.trim() && this.unitInput.value.trim()); }
                    },
                    preparePage2() {
                        const d = new Date(); const ts = `${String(d.getFullYear()).slice(-2)}${String(d.getMonth() + 1).padStart(2, '0')}${String(d.getDate()).padStart(2, '0')}${String(d.getHours()).padStart(2, '0')}${String(d.getMinutes()).padStart(2, '0')}${String(d.getSeconds()).padStart(2, '0')}`;
                        this.requestIdInput.value = `ISU-${ts}${String(Math.floor(Math.random() * 9000) + 1000)}`;
                        const projectSelection = this.selectedItems.find(item => item.type === 'project');
                        if (projectSelection) { this.selectedItemInput.value = `${projectSelection.id}`; }
                        else { const parentId = this.selectedItems[0].parent; const childrenIds = this.selectedItems.map(item => `${item.type.toUpperCase()}-${item.id}`).join(', '); this.selectedItemInput.value = `${parentId} (${childrenIds})`; }
                    },
                    async submitForm() {
                        this.submitBtn.disabled = true; this.submitBtn.innerHTML = '<i class="ri-loader-4-line" style="animation: spin 1s linear infinite;"></i> 提交中...';
                        const formData = { id: this.requestIdInput.value, correlationId: this.selectedItemInput.value, category: this.categorySelect.value, name: this.nameInput.value, fillerId: this.fillerIdInput.value, unit: this.unitInput.value, text: this.descriptionText.value };
                        try {
                            const response = await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(formData) });
                            this.feedbackSuccess.style.display = 'block'; this.feedbackError.style.display = 'none';
                        } catch (error) { console.error('Submission failed:', error); this.feedbackSuccess.style.display = 'none'; this.feedbackError.style.display = 'block'; }
                        finally { this.goToPage(4); }
                    },
                    generateMailto() {
                        const formData = { id: this.requestIdInput.value, correlationId: this.selectedItemInput.value, category: this.categorySelect.value, text: this.descriptionText.value, name: this.nameInput.value, fillerId: this.fillerIdInput.value, unit: this.unitInput.value };
                        const emailDisclaimer = "**...**\n"; const emailBody = `${emailDisclaimer}\n...`; const subject = `服务请求: [${formData.category}] - ${formData.id}`;
                        window.location.href = `mailto:support_ksvg@163.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
                    }
                };
                document.getElementById('new-request-button').addEventListener('click', () => requestFormModal.open());
                requestFormModal.closeBtn.addEventListener('click', () => requestFormModal.close());
                requestFormModal.closeFinalBtn.addEventListener('click', () => requestFormModal.close());
                requestFormModal.backBtn.addEventListener('click', () => requestFormModal.goToPage(requestFormModal.currentPage - 1));
                requestFormModal.nextBtn.addEventListener('click', () => { if (requestFormModal.currentPage === 1) requestFormModal.preparePage2(); requestFormModal.goToPage(requestFormModal.currentPage + 1); });
                requestFormModal.submitBtn.addEventListener('click', () => requestFormModal.submitForm());
                requestFormModal.emailFallbackLink.addEventListener('click', (e) => { e.preventDefault(); requestFormModal.generateMailto(); });
                requestFormModal.selectionList.addEventListener('change', (e) => requestFormModal.handleSelectionChange(e));
                requestFormModal.descriptionText.addEventListener('input', () => requestFormModal.updateFormState());
                [requestFormModal.nameInput, requestFormModal.fillerIdInput, requestFormModal.unitInput].forEach(el => el.addEventListener('input', () => requestFormModal.updateFormState()));

                loadAllData();
            });
        } catch (e) { console.error("A critical error occurred on the page:", e); document.getElementById('project-table-body').innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 40px; color: red;">页面脚本发生严重错误，请联系管理员。</td></tr>`; }
    </script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7FP90XJEB6"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-7FP90XJEB6');
    </script>
</body>

</html>