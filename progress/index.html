<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KSVG | 项目进展</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poppins:wght@700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="icon" href="https://raw.githubusercontent.com/KCIS-KSVG/Data/main/embed/ksvg-logo.png" type="image/png">
    <style>
        :root {
            --primary-color: #920783; --secondary-color: #007bff; --dark-gray: #1d1d1f;
            --medium-gray: #424245; --light-gray: #f5f5f7; --text-color: #1d1d1f;
            --header-height: 70px; --status-ongoing-bg: #e6f7ff; --status-ongoing-text: #006d9c;
            --status-completed-bg: #f6ffed; --status-completed-text: #389e0d; --status-archived-bg: #fafafa;
            --status-archived-text: #8c8c8c; --status-planned-bg: #f0f5ff; --status-planned-text: #2f54eb;
            --status-cancelled-bg: #fff1f0; --status-cancelled-text: #cf1322;
        }
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif; background-color: var(--light-gray); color: var(--text-color);
            line-height: 1.6; display: flex; flex-direction: column; min-height: 100vh;
        }
        body.no-scroll { overflow: hidden; }
        a { text-decoration: none; color: inherit; }
        .site-header {
            background-color: rgba(255, 255, 255, 0.8); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid #ddd; position: fixed; top: 0; left: 0; width: 100%; height: var(--header-height); z-index: 1020;
        }
        .navigation {
            max-width: 1280px; margin: 0 auto; padding: 0 30px; height: 100%; display: flex;
            justify-content: space-between; align-items: center;
        }
        .logo-image { height: 45px; }
        .nav-menu { list-style: none; display: flex; gap: 30px; }
        .nav-menu li a {
            color: var(--medium-gray); font-size: 0.9rem; font-weight: 600; padding: 5px 0;
            position: relative; transition: color 0.3s ease;
        }
        .nav-menu li a::after {
            content: ''; position: absolute; width: 80%; height: 3px; bottom: -5px; left: 10%;
            background-color: var(--primary-color); transform: scaleX(0); transform-origin: bottom left;
            transition: transform 0.4s cubic-bezier(0.23, 1, 0.32, 1);
        }
        .nav-menu li a:hover, .nav-menu li a.active { color: var(--dark-gray); }
        .nav-menu li a:hover::after, .nav-menu li a.active::after {
            transform: scaleX(1); transform-origin: bottom left;
        }
        .nav-toggle {
            display: none; background: none; border: none; font-size: 28px; color: var(--dark-gray);
            cursor: pointer; z-index: 1030; transition: transform 0.4s ease;
        }
        .nav-toggle.is-active { transform: rotate(90deg); }
        main { padding-top: var(--header-height); flex-grow: 1; }
        .page-intro { padding: 60px 30px; background-color: #fff; border-bottom: 1px solid #e0e0e0; }
        .page-container { max-width: 1280px; margin: 0 auto; }
        .page-intro h1 { font-family: 'Poppins', sans-serif; font-size: 2.5rem; margin-bottom: 10px; }
        .page-intro p { font-size: 1.1rem; color: var(--medium-gray); max-width: 800px; }
        .content-section { padding: 40px 30px 60px; }
        .controls-wrapper { display: flex; flex-direction: column; gap: 20px; margin-bottom: 30px; }
        .main-controls { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 20px; }
        .left-controls { display: flex; flex-direction: column; gap: 15px; }
        .filter-controls { display: flex; gap: 10px; flex-wrap: wrap; }
        .filter-btn { background-color: #fff; border: 1px solid #d9d9d9; padding: 8px 16px; border-radius: 6px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .filter-btn:hover { color: var(--primary-color); border-color: var(--primary-color); }
        .filter-btn.active { background-color: var(--primary-color); color: #fff; border-color: var(--primary-color); }
        .right-controls { display: flex; flex-direction: column; align-items: flex-end; gap: 15px; }
        .search-controls { display: flex; }
        .search-input { border: 1px solid #d9d9d9; padding: 10px 16px; border-radius: 8px 0 0 8px; font-size: 1rem; width: 300px; border-right: none; outline: none; }
        .search-button { background-color: var(--primary-color); color: #fff; border: 1px solid var(--primary-color); padding: 0 16px; border-radius: 0 8px 8px 0; font-size: 1.2rem; cursor: pointer; transition: background-color 0.3s ease; display: flex; align-items: center; }
        .search-button:hover { background-color: #7a066e; }
        .action-button { background-color: #fff; border: 1px solid #d9d9d9; padding: 8px 16px; border-radius: 6px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; }
        .action-button:hover { color: var(--primary-color); border-color: var(--primary-color); }
        .post-filter-controls { display: flex; gap: 20px; align-items: center; font-size: 0.9rem; }
        .checkbox-group input[type="checkbox"] { display: none; }
        .checkbox-group label { display: flex; align-items: center; gap: 8px; cursor: not-allowed; font-weight: 600; color: #ccc; user-select: none; transition: color 0.3s ease; }
        .checkbox-group label.enabled { color: var(--medium-gray); cursor: pointer; }
        .checkbox-icon { width: 18px; height: 18px; border: 2px solid #ccc; border-radius: 5px; position: relative; transition: all 0.2s ease-in-out; }
        .checkbox-group label.enabled .checkbox-icon { border-color: #a9a9a9; }
        .checkbox-icon .tick { position: absolute; top: 1px; left: 4px; width: 5px; height: 10px; border: solid white; border-width: 0 3px 3px 0; transform: rotate(45deg) scale(0); transition: transform 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        .checkbox-group input[type="checkbox"]:checked + label .checkbox-icon { background-color: var(--secondary-color); border-color: var(--secondary-color); }
        .checkbox-group input[type="checkbox"]:checked + label .checkbox-icon .tick { transform: rotate(45deg) scale(1); }
        .table-container { position: relative; background-color: #fff; border-radius: 8px; overflow-x: auto; border: 1px solid #e0e0e0; min-height: 300px; }
        #loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.85); backdrop-filter: blur(5px); z-index: 10; display: flex; justify-content: center; align-items: center; transition: opacity 0.3s; opacity: 0; pointer-events: none; }
        #loading-overlay.visible { opacity: 1; pointer-events: auto; }
        .loader { border: 7px solid #f3f3f3; border-top: 7px solid var(--primary-color); border-radius: 50%; width: 70px; height: 70px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .project-table { width: 100%; min-width: 1000px; border-collapse: collapse; }
        .project-table th { position: sticky; top: 0; background-color: #fafafa; z-index: 1; }
        .sortable-header { cursor: pointer; user-select: none; } .sortable-header:hover { background-color: #f0f0f0; }
        .sort-indicator { display: inline-block; width: 1em; opacity: 0.5; font-size: 0.8em; margin-left: 5px; color: var(--dark-gray); }
        .sortable-header.sort-asc .sort-indicator, .sortable-header.sort-desc .sort-indicator { opacity: 1; }
        .project-table th, .project-table td { padding: 10px 15px; text-align: left; border-bottom: 1px solid #f0f0f0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; vertical-align: middle; font-size: 0.9rem; }
        #match-details-header, .match-details-cell { display: none; }
        .project-table.is-searching #match-details-header, .project-table.is-searching .match-details-cell { display: table-cell; }
        .project-row { cursor: pointer; transition: background-color 0.3s ease; } .project-row:hover { background-color: #f9f9f9; }
        .status-badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 0.85rem; font-weight: 600; }
        .status-计划 { background-color: var(--status-planned-bg); color: var(--status-planned-text); } .status-进行 { background-color: var(--status-ongoing-bg); color: var(--status-ongoing-text); } .status-完成 { background-color: var(--status-completed-bg); color: var(--status-completed-text); } .status-归档 { background-color: var(--status-archived-bg); color: var(--status-archived-text); } .status-取消 { background-color: var(--status-cancelled-bg); color: var(--status-cancelled-text); }
        mark.highlight { background-color: #fff38a; color: #000; padding: 2px; border-radius: 2px; }
        .match-badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600; margin-right: 5px; margin-bottom: 5px; }
        .match-badge-project { background-color: #e6f7ff; color: #1890ff; }
        .match-badge-session { background-color: #f6ffed; color: #52c41a; }
        .match-badge-product { background-color: #fffbe6; color: #faad14; }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(29, 29, 31, 0.5);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            z-index: 2000; opacity: 0; pointer-events: none;
            transition: opacity 0.4s cubic-bezier(0.23, 1, 0.32, 1);
        }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        
        #request-modal { display: flex; justify-content: center; align-items: center; }
        #request-modal .modal-content {
            background: #fff; border-radius: 12px; width: 90%; max-width: 600px; padding: 30px;
            display: flex; flex-direction: column; max-height: 85vh; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            transform: scale(0.95); opacity: 0;
            transition: transform 0.4s cubic-bezier(0.23, 1, 0.32, 1), opacity 0.4s cubic-bezier(0.23, 1, 0.32, 1);
        }
        #request-modal.visible .modal-content { transform: scale(1); opacity: 1; }
        
        #details-modal { display: flex; justify-content: center; align-items: center; }
        #details-modal .modal-content {
            position: relative; width: 90%; max-width: 1200px; height: 90vh;
            background: var(--light-gray); border-radius: 12px; display: flex; flex-direction: column;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); transform: scale(0.95); opacity: 0;
            transition: transform 0.4s cubic-bezier(0.23, 1, 0.32, 1), opacity 0.4s cubic-bezier(0.23, 1, 0.32, 1);
        }
        #details-modal.visible .modal-content { transform: scale(1); opacity: 1; }
        
        .modal-header { flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; padding: 20px 25px; border-bottom: 1px solid #ddd; }
        .modal-header .header-left { display: flex; align-items: center; gap: 20px; }
        .modal-header h2 { margin: 0; font-size: 1.5rem; }
        .modal-header .header-actions { display: flex; gap: 15px; }
        .modal-close { background: none; border: none; font-size: 28px; cursor: pointer; color: var(--medium-gray); }
        .modal-body { flex-grow: 1; overflow-y: auto; padding: 25px; }
        .detail-card { background: #fff; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 20px; }
        .detail-card h3 { font-size: 1.2rem; padding: 15px 20px; border-bottom: 1px solid #e8e8e8; }
        .detail-card-body { padding: 20px; }
        .detail-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px 30px; }
        .detail-item { display: flex; flex-direction: column; }
        .detail-item .label { font-size: 0.9rem; color: var(--medium-gray); font-weight: 600; margin-bottom: 5px; }
        .detail-item .value { font-size: 1rem; color: var(--dark-gray); }
        .detail-item .value.description { white-space: pre-wrap; line-height: 1.7; grid-column: 1 / -1; }
        .session-card { border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px; background: #fff; }
        .session-header { background: #fafafa; padding: 15px 20px; border-bottom: 1px solid #ddd; border-radius: 8px 8px 0 0; }
        .session-header h4 { font-size: 1.2rem; margin: 0; display: flex; justify-content: space-between; align-items: center; }
        .session-body { padding: 20px; }
        .session-body h5 { font-size: 1rem; margin-top: 20px; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid #eee; }
        .session-body h5:first-child { margin-top: 0; }
        .details-table-wrapper { overflow-x: auto; border: 1px solid #e8e8e8; border-radius: 6px; }
        .details-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .details-table th, .details-table td { padding: 10px; text-align: left; border-bottom: 1px solid #f0f0f0; white-space: nowrap; border-right: 1px solid #f0f0f0; }
        .details-table th:last-child, .details-table td:last-child { border-right: none; }
        .details-table th { background: #f9f9f9; }
        .details-table tr:last-child td { border-bottom: none; }
        .no-data { color: var(--medium-gray); padding: 20px; text-align: center; }
        .modal-page { display: none; } .modal-page.active { display: block; }
        .form-group { margin-bottom: 20px; } .form-group label { display: block; font-weight: 600; margin-bottom: 8px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; }
        .form-group textarea { resize: vertical; min-height: 100px; }
        .form-group .readonly-field { background: #f0f0f0; cursor: not-allowed; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .selection-list { max-height: 300px; overflow-y: auto; border: 1px solid #ccc; border-radius: 4px; padding: 10px; }
        .selection-item label { font-weight: normal; display: flex; align-items: center; cursor: pointer;}
        .selection-item input[type="checkbox"] { margin-right: 10px; width: 18px; height: 18px; }
        .selection-item-project { font-weight: bold; } .selection-item-session { padding-left: 25px; } .selection-item-product { padding-left: 25px; color: #555; }
        .modal-footer { flex-shrink: 0; display: flex; justify-content: flex-end; gap: 15px; border-top: 1px solid #eee; padding-top: 20px; margin-top: 20px; }
        .modal-button { display: inline-flex; align-items: center; gap: 8px; padding: 8px 18px; border-radius: 6px; font-size: 0.9rem; font-weight: 600; cursor: pointer; border: 1px solid transparent; transition: all 0.2s ease; }
        .modal-button-primary { background: var(--primary-color); color: #fff; } .modal-button-primary:hover { background: #7a066e; }
        .modal-button-secondary { background: #eee; border-color: #ddd; } .modal-button-secondary:hover { background: #ddd; }
        .modal-button:disabled { background: #ccc; cursor: not-allowed; }
        .footer { background-color: var(--dark-gray); color: rgba(255, 255, 255, 0.7); padding: 60px 30px; }
        .footer-container { max-width: 1280px; margin: 0 auto; display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 40px; }
        .footer-left p { margin-bottom: 20px; font-size: 0.9rem; }
        .footer-socials { display: flex; gap: 20px; }
        .footer-socials a i { font-size: 24px; color: rgba(255, 255, 255, 0.7); transition: color 0.3s ease; }
        .footer-socials a:hover i { color: var(--primary-color); }
        .footer-address { font-size: 0.9rem; text-align: right; line-height: 1.8; }
        
        @media (max-width: 992px) {
            .detail-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .nav-toggle { display: block; }
            .navigation .nav-menu {
                position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
                background-color: rgba(255, 255, 255, 0.98); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
                display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 40px;
                transform: translateY(-100%);
                transition: transform 0.8s cubic-bezier(0.23, 1, 0.32, 1);
                z-index: 1010;
            }
            .nav-menu.is-active { transform: translateY(0); }
            .nav-menu li {
                opacity: 0; transform: translateY(-20px);
                transition: opacity 0.5s cubic-bezier(0.23, 1, 0.32, 1), transform 0.5s cubic-bezier(0.23, 1, 0.32, 1);
            }
            .nav-menu.is-active li { opacity: 1; transform: translateY(0); }
            .nav-menu.is-active li:nth-child(1) { transition-delay: 0.3s; }
            .nav-menu.is-active li:nth-child(2) { transition-delay: 0.35s; }
            .nav-menu.is-active li:nth-child(3) { transition-delay: 0.4s; }
            .nav-menu.is-active li:nth-child(4) { transition-delay: 0.45s; }
            .nav-menu.is-active li:nth-child(5) { transition-delay: 0.5s; }
            .nav-menu.is-active li:nth-child(6) { transition-delay: 0.55s; }
            .nav-menu li a { font-size: 1.5rem; }
            .form-grid { grid-template-columns: 1fr; }
            .footer-container { flex-direction: column; text-align: center; align-items: center; }
            .footer-address { text-align: center; }
            #details-modal .modal-content { top: var(--header-height); bottom: 0; left: 0; right: 0; width: 100%; height: calc(100vh - var(--header-height)); border-radius: 0; }
            #details-modal .modal-body { padding: 15px; }
            #details-modal .modal-header { padding: 15px; }
            .detail-grid {
                grid-template-columns: 1fr 1fr;
                gap: 15px 10px;
                position: relative;
            }
            .detail-grid::after {
                content: ''; position: absolute; left: 50%; top: 0; bottom: 0;
                width: 1px; background-color: #e8e8e8; transform: translateX(-50%);
            }
            .detail-item { padding: 0 5px; }
            .detail-item.value.description { grid-column: 1 / -1; }
            .main-controls { flex-direction: column; align-items: stretch; gap: 25px; }
            .left-controls, .right-controls { align-items: stretch; width: 100%; }
            .search-controls { width: 100%; }
            .search-input { width: 100%; }
        }
        
        @page { size: portrait; margin: 1in; }
        @media print {
            body > *:not(.print-area) { display: none; }
            .print-area { display: block !important; }
            .print-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; border-bottom: 1px solid #ddd; }
            .print-header h2 { font-size: 1.5rem; margin: 0; }
            .print-logo { max-height: 40px; }
            .print-footer { position: fixed; bottom: 30px; left: 30px; font-size: 10px; color: #666; }
            .modal-body { overflow: visible !important; height: auto !important; }
            .details-table-wrapper { overflow-x: visible !important; }
            .detail-card, .session-card { page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <header class="site-header">
        <nav class="navigation">
            <a href="https://ksvg.com.cn/" class="logo-link"><img src="https://raw.githubusercontent.com/KCIS-KSVG/Data/main/embed/ksvg-logo.png" alt="KSVG Logo" class="logo-image"></a>
            <ul class="nav-menu">
                <li><a href="https://ksvg.com.cn/">主页</a></li>
                <li><a href="https://ksvg.com.cn/progress/" class="active">项目进展</a></li>
                <li><a href="https://ksvg.com.cn/media/">媒体共享</a></li>
                <li><a href="https://ksvg.com.cn/documentation/">文件共享</a></li>
                <li><a href="https://ksvg.com.cn/schedule/">日程信息</a></li>
                <li><a href="https://ksvg.com.cn/recruiting/">组织招募</a></li>
            </ul>
            <button class="nav-toggle" aria-label="Open menu"><i class="ri-menu-line"></i></button>
        </nav>
    </header>

    <main>
        <section class="page-intro">
            <div class="page-container">
                <h1>项目进展</h1>
                <p>在此查询所有已备案项目的当前状态、执行详情及历史记录。点击项目行可弹出详情窗口。</p>
            </div>
        </section>
        <section class="content-section">
            <div class="page-container">
                <div class="controls-wrapper">
                    <div class="main-controls">
                        <div class="left-controls">
                            <div class="filter-controls">
                                <button class="filter-btn active" data-filter="all">所有项目</button>
                                <button class="filter-btn" data-filter="计划">计划</button>
                                <button class="filter-btn" data-filter="进行">进行</button>
                                <button class="filter-btn" data-filter="完成">完成</button>
                                <button class="filter-btn" data-filter="归档">归档</button>
                                <button class="filter-btn" data-filter="取消">取消</button>
                            </div>
                            <div class="post-filter-controls">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="only-project-match" disabled>
                                    <label for="only-project-match"><span class="checkbox-icon"><span class="tick"></span></span> 仅显示项目匹配</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="only-session-match" disabled>
                                    <label for="only-session-match"><span class="checkbox-icon"><span class="tick"></span></span> 仅显示场次匹配</label>
                                </div>
                            </div>
                        </div>
                        <div class="right-controls">
                            <div class="search-controls">
                                <input type="search" class="search-input" id="search-input" placeholder="键入关键词以搜索...">
                                <button class="search-button" id="search-button"><i class="ri-search-line"></i></button>
                            </div>
                            <button class="action-button" id="new-request-button"><i class="ri-mail-add-line"></i> 新增邮件请求</button>
                        </div>
                    </div>
                </div>
                <div class="table-container" id="table-area">
                    <div id="loading-overlay">
                        <div class="loader"></div>
                    </div>
                    <table class="project-table">
                        <thead>
                            <tr>
                                <th class="sortable-header" data-sort="name">项目名称 <span class="sort-indicator"></span></th>
                                <th class="sortable-header" data-sort="id">内部编号 <span class="sort-indicator"></span></th>
                                <th class="sortable-header" data-sort="startDate">开始日期 <span class="sort-indicator"></span></th>
                                <th class="sortable-header" data-sort="endDate">结束日期 <span class="sort-indicator"></span></th>
                                <th class="sortable-header" data-sort="department">合作部门 <span class="sort-indicator"></span></th>
                                <th class="sortable-header" data-sort="status">状态 <span class="sort-indicator"></span></th>
                                <th id="match-details-header" style="min-width: 150px;">搜索匹配</th>
                            </tr>
                        </thead>
                        <tbody id="project-table-body"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <div class="modal-overlay" id="details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="header-left"><h2 id="details-modal-title"></h2></div>
                <div class="header-actions">
                    <button class="modal-button modal-button-secondary" id="details-modal-print-button"><i class="ri-printer-line"></i>输出</button>
                    <button class="modal-close" id="details-modal-close-button"><i class="ri-close-line"></i></button>
                </div>
            </div>
            <div class="modal-body" id="details-modal-body"></div>
        </div>
    </div>
    <div id="print-container" class="print-area" style="display: none;"></div>

    <div class="modal-overlay" id="request-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">新增邮件请求 (1/2)</h2>
                <button class="modal-close" id="modal-close-button"><i class="ri-close-line"></i></button>
            </div>
            <div class="modal-body">
                <div class="modal-page active" id="modal-page-1"><div class="form-group"><label>选择相关项目/场次/产品 (可多选)</label><div class="selection-list" id="modal-selection-list"></div></div></div>
                <div class="modal-page" id="modal-page-2">
                    <div class="form-group"><label>已选请求目标</label><textarea id="modal-selected-item" class="readonly-field" readonly rows="2"></textarea></div>
                    <div class="form-group"><label>请求单号</label><input type="text" id="modal-request-id" class="readonly-field" readonly></div>
                    <div class="form-grid"><div class="form-group"><label for="modal-name">姓名</label><input type="text" id="modal-name" required></div><div class="form-group"><label for="modal-id-number">学号/工号</label><input type="text" id="modal-id-number" required></div></div>
                    <div class="form-group"><label for="modal-class-dept">班级/部门</label><input type="text" id="modal-class-dept" required></div>
                    <div class="form-group"><label for="modal-category">事件类别</label><select id="modal-category"><option value="服务反馈">服务反馈</option><option value="加急请求">加急请求</option><option value="状态请求">状态请求</option><option value="变更信息">变更信息</option><option value="其他类别">其他类别</option></select></div>
                    <div class="form-group"><label for="modal-description">具体描述</label><textarea id="modal-description" placeholder="请详细描述您的请求..."></textarea></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-button modal-button-secondary" id="modal-back-button" style="display: none;">返回</button>
                <button class="modal-button modal-button-primary" id="modal-continue-button" disabled>继续</button>
                <button class="modal-button modal-button-primary" id="modal-submit-button" style="display: none;" disabled>生成邮件</button>
            </div>
        </div>
    </div>
    
    <footer class="footer">
        <div class="footer-container">
            <div class="footer-left">
                <p>© 2025 TonyJian-KSVG. All Rights Reserved.</p>
                <div class="footer-socials">
                    <a href="https://space.bilibili.com/23855258?spm_id_from=333.1007.0.0" aria-label="Bilibili" title="Bilibili"><i class="ri-bilibili-fill"></i></a>
                    <a href="https://www.youtube.com/@kcisec-ksvg" aria-label="YouTube" title="YouTube"><i class="ri-youtube-fill"></i></a>
                    <a href="mailto:support_ksvg@163.com" aria-label="Email" title="Email"><i class="ri-mail-line"></i></a>
                </div>
            </div>
            <div class="footer-address">
                <p>Kang Chiao International School East China</p>
                <p>No.500, Xihuan Road, Huaqiao Economic Development Zone, Kunshan, Jiangsu</p>
            </div>
        </div>
    </footer>
    <script>
    try {
        document.addEventListener("DOMContentLoaded", function () {
            const navToggle = document.querySelector('.nav-toggle'); const navMenu = document.querySelector('.nav-menu'); const body = document.body;
            if (navToggle && navMenu) {
                const icon = navToggle.querySelector('i');
                const toggleMenu = (forceClose = false) => {
                    const isActive = navMenu.classList.contains('is-active');
                    if (forceClose || isActive) {
                        navMenu.classList.remove('is-active'); navToggle.classList.remove('is-active');
                        body.classList.remove('no-scroll'); icon.className = 'ri-menu-line';
                    } else {
                        navMenu.classList.add('is-active'); navToggle.classList.add('is-active');
                        body.classList.add('no-scroll'); icon.className = 'ri-close-line';
                    }
                };
                navToggle.addEventListener('click', () => toggleMenu());
                const navLinks = navMenu.querySelectorAll('a');
                navLinks.forEach(link => { link.addEventListener('click', () => { setTimeout(() => toggleMenu(true), 100); }); });
            }
            
            const BASE_URL = 'https://raw.githubusercontent.com/KCIS-KSVG/Data/main/progress/';
            const URLS = {
                projects: `${BASE_URL}ksvg.com.cn_progress_data%20-%20projects.csv`, sessions: `${BASE_URL}ksvg.com.cn_progress_data%20-%20sessions.csv`,
                prodRequests: `${BASE_URL}ksvg.com.cn_progress_data%20-%20prodRequest.csv`, equiRequests: `${BASE_URL}ksvg.com.cn_progress_data%20-%20equiRequest.csv`,
                staffRequests: `${BASE_URL}ksvg.com.cn_progress_data%20-%20staffRequest.csv`, bdEquipment: `${BASE_URL}ksvg.com.cn_progress_data%20-%20BD_Equipment.csv`,
                bdStaff: `${BASE_URL}ksvg.com.cn_progress_data%20-%20BD_Staff.csv`
            };
            const EMAIL_RECIPIENT = "support_ksvg@163.com";
            let allData = []; let currentFilter = 'all'; let currentSort = { key: 'id', order: 'asc' };
            const ui = {
                loadingOverlay: document.getElementById('loading-overlay'), tableBody: document.getElementById('project-table-body'), table: document.querySelector('.project-table'),
                tableHead: document.querySelector('.project-table thead'),
                searchInput: document.getElementById('search-input'), searchButton: document.getElementById('search-button'), filterBtns: document.querySelectorAll('.filter-btn'),
                projectMatchLabel: document.querySelector('label[for="only-project-match"]'), sessionMatchLabel: document.querySelector('label[for="only-session-match"]'),
                projectMatchCheckbox: document.getElementById('only-project-match'), sessionMatchCheckbox: document.getElementById('only-session-match')
            };
            const requestModal = {
                overlay: document.getElementById('request-modal'), title: document.getElementById('modal-title'), page1: document.getElementById('modal-page-1'), page2: document.getElementById('modal-page-2'),
                selectionList: document.getElementById('modal-selection-list'), selectedItemInput: document.getElementById('modal-selected-item'), requestIdInput: document.getElementById('modal-request-id'),
                nameInput: document.getElementById('modal-name'), idNumberInput: document.getElementById('modal-id-number'), classDeptInput: document.getElementById('modal-class-dept'),
                categorySelect: document.getElementById('modal-category'), descriptionText: document.getElementById('modal-description'), backBtn: document.getElementById('modal-back-button'),
                continueBtn: document.getElementById('modal-continue-button'), submitBtn: document.getElementById('modal-submit-button'), closeBtn: document.querySelector('#request-modal .modal-close')
            };
            
            const detailsModal = {
                overlay: document.getElementById('details-modal'), title: document.getElementById('details-modal-title'),
                body: document.getElementById('details-modal-body'), closeBtn: document.getElementById('details-modal-close-button'),
                printBtn: document.getElementById('details-modal-print-button'), currentProjectId: null,
                open(projectId) {
                    const project = allData.find(p => p.id === projectId); if (!project) return;
                    this.currentProjectId = project.id; this.title.textContent = project.name;
                    this.body.innerHTML = this.generateContent(project);
                    this.overlay.classList.add('visible'); body.classList.add('no-scroll');
                },
                close() { this.overlay.classList.remove('visible'); body.classList.remove('no-scroll'); },
                generateContent(p) {
                    const searchTerm = ui.searchInput.value.toLowerCase().trim();
                    const createDetailItem = (label, value) => value ? `<div class="detail-item"><div class="label">${label}</div><div class="value">${highlight(value, searchTerm)}</div></div>` : '';
                    const createDescriptionItem = (label, value) => value ? `<div class="detail-item value description"><div class="label">${label}</div>${highlight(value, searchTerm)}</div>` : '';
                    
                    const projectDetails = `<div class="detail-card"><h3>项目详情</h3><div class="detail-card-body"><div class="detail-grid">
                        ${createDetailItem('内部编号', p.id)} ${createDetailItem('合作部门', p.department)}
                        ${createDetailItem('状态', `<span class="status-badge status-${p.status}">${p.status}</span>`)}
                        ${createDetailItem('开始日期', serialToDate(p.startDate))} ${createDetailItem('结束日期', serialToDate(p.endDate))}
                        ${createDetailItem('项目经理', p.manager)}
                        ${createDescriptionItem('项目描述', p.description)}
                        </div></div></div>`;

                    const productRequests = p.products && p.products.length > 0 ? `<div class="detail-card"><h3>产品请求</h3><div class="detail-card-body" style="padding:0;">
                        <div class="details-table-wrapper"><table class="details-table"><thead><tr><th>编号</th><th>类别</th><th>名称</th><th>负责人</th><th>状态</th><th>备注</th></tr></thead><tbody>
                        ${p.products.map(pr => `<tr><td>${highlight(pr.id, searchTerm)}</td><td>${highlight(pr.category, searchTerm)}</td><td>${highlight(pr.name, searchTerm)}</td><td>${highlight(pr.staff, searchTerm)}</td><td><span class="status-badge status-${pr.status}">${pr.status}</span></td><td>${highlight(pr.notes, searchTerm)}</td></tr>`).join('')}
                        </tbody></table></div></div></div>` : '';

                    const sessions = p.sessions && p.sessions.length > 0 ? p.sessions.map(s => `<div class="session-card">
                        <div class="session-header"><h4>${highlight(s.name, searchTerm)} (${highlight(s.id, searchTerm)}) <span class="status-badge status-${s.status}">${s.status}</span></h4></div>
                        <div class="session-body">
                            <div class="detail-grid" style="grid-template-columns: repeat(2, 1fr); margin-bottom: 20px;">
                                ${createDetailItem('场地', s.site)} ${createDetailItem('日期', `${serialToDate(s.startDate)} ~ ${serialToDate(s.endDate)}`)}
                                ${createDescriptionItem('备注', s.notes)}
                            </div>
                            ${s.equipment && s.equipment.length > 0 ? `<h5>设备请求</h5><div class="details-table-wrapper"><table class="details-table"><thead><tr><th>设备ID</th><th>名称</th><th>类别</th><th>所有者</th><th>序列号</th><th>备注</th></tr></thead><tbody>
                                ${s.equipment.map(e => `<tr><td>${highlight(e.id, searchTerm)}</td><td>${highlight(e.name, searchTerm)}</td><td>${highlight(e.category, searchTerm)}</td><td>${highlight(e.owner, searchTerm)}</td><td>${highlight(e.serialNumbers, searchTerm)}</td><td>${highlight(e.notes, searchTerm)}</td></tr>`).join('')}
                            </tbody></table></div>` : '<div class="no-data">无设备请求</div>'}
                            ${s.staff && s.staff.length > 0 ? `<h5>人员分配</h5><div class="details-table-wrapper"><table class="details-table"><thead><tr><th>姓名</th><th>职位</th><th>学号/ID</th><th>备注</th></tr></thead><tbody>
                                ${s.staff.map(st => `<tr><td>${highlight(st.Name, searchTerm)}</td><td>${highlight(st.position, searchTerm)}</td><td>${highlight(st.identity, searchTerm)}</td><td>${highlight(st.note, searchTerm)}</td></tr>`).join('')}
                            </tbody></table></div>` : '<div class="no-data">无人员分配</div>'}
                        </div></div>`).join('') : '<div class="detail-card"><div class="no-data">此项目没有关联场次</div></div>';

                    return projectDetails + productRequests + sessions;
                }
            };

            function parseCSV(text) { if (!text) return []; const lines = text.trim().split(/\r?\n/); if (lines.length < 2) return []; const headers = lines[0].split(',').map(h => h.trim()); return lines.slice(1).map(line => { const values = line.split(','); return headers.reduce((obj, header, index) => { obj[header] = (values[index] || '').trim(); return obj; }, {}); }); }
            async function fetchCSV(url) { const response = await fetch(`${url}?v=${new Date().getTime()}`); if (!response.ok) throw new Error(`Failed to fetch ${url}: ${response.statusText}`); return await response.text(); }
            
            async function loadAllData() {
                ui.loadingOverlay.classList.add('visible');
                try {
                    const results = await Promise.allSettled(Object.values(URLS).map(fetchCSV));
                    const [projectsCSV, sessionsCSV, prodRequestsCSV, equiRequestsCSV, staffRequestsCSV, bdEquipmentCSV, bdStaffCSV] = results.map(res => res.status === 'fulfilled' ? res.value : '');
                    if (!projectsCSV) throw new Error("Critical file 'projects.csv' failed to load.");
                    const projects = parseCSV(projectsCSV); const sessions = parseCSV(sessionsCSV);
                    const prodRequests = parseCSV(prodRequestsCSV); const equiRequests = parseCSV(equiRequestsCSV);
                    const staffRequests = parseCSV(staffRequestsCSV); const bdEquipment = parseCSV(bdEquipmentCSV);
                    const bdStaff = parseCSV(bdStaffCSV);
                    allData = projects.map(p => {
                        const projectSessions = sessions.filter(s => s.projectId === p.id).map(s => {
                            const resolvedEquipment = equiRequests.filter(er => er.sessionId === s.id).map(req => ({ ...req, ...(bdEquipment.find(dev => dev.id === req.id) || {}) }));
                            const resolvedStaff = staffRequests.filter(sr => sr.sessionId === s.id).map(req => ({ ...req, ...(bdStaff.find(staff => staff.id === req.identity) || {}) }));
                            return { ...s, equipment: resolvedEquipment, staff: resolvedStaff };
                        });
                        return { ...p, sessions: projectSessions, products: prodRequests.filter(pr => pr.projectId === p.id) };
                    });
                    applyFiltersAndSearch();
                    
                    const params = new URLSearchParams(window.location.search);
                    const projectIdToOpen = params.get('open');
                    if (projectIdToOpen) {
                        if (allData.some(p => p.id === projectIdToOpen)) {
                            detailsModal.open(projectIdToOpen);
                        } else {
                            console.warn(`Project ID "${projectIdToOpen}" from URL not found.`);
                        }
                        const newUrl = window.location.pathname;
                        history.replaceState({}, '', newUrl);
                    }
                } catch (error) { console.error('Data loading or processing failed:', error); ui.tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 40px; color: red;">数据加载失败: ${error.message}</td></tr>`; } finally { ui.loadingOverlay.classList.remove('visible'); }
            }
            function serialToDate(serial) { if (!serial || isNaN(serial)) return 'N/A'; const date = new Date(Date.UTC(1899, 11, 30) + serial * 86400000); return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`; }
            function highlight(text, term) { if (!term || !text) return text; return text.toString().replace(new RegExp(term.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'gi'), match => `<mark class="highlight">${match}</mark>`); }
            
            function renderTable(data, searchTerm = '') {
                data.sort((a, b) => { const valA = a[currentSort.key]; const valB = b[currentSort.key]; let comparison = String(valA).localeCompare(String(valB), undefined, { numeric: true }); return currentSort.order === 'asc' ? comparison : -comparison; });
                ui.tableHead.querySelectorAll('.sortable-header').forEach(th => { th.classList.remove('sort-asc', 'sort-desc'); const indicator = th.querySelector('.sort-indicator'); if (th.dataset.sort === currentSort.key) { th.classList.add(`sort-${currentSort.order}`); indicator.textContent = currentSort.order === 'asc' ? '▲' : '▼'; } else { indicator.textContent = ''; } });
                ui.tableBody.innerHTML = ''; if (data.length === 0) { ui.tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 40px;">未找到匹配的项目。</td></tr>`; return; }
                data.forEach(p => {
                    const projectRow = document.createElement('tr');
                    projectRow.className = 'project-row'; projectRow.dataset.id = p.id;
                    let matchDetailsHTML = '';
                    if (searchTerm) {
                        if (p.projectMatchCount > 0) matchDetailsHTML += `<span class="match-badge match-badge-project">项目匹配: ${p.projectMatchCount}</span>`;
                        if (p.sessionMatchCount > 0) matchDetailsHTML += `<span class="match-badge match-badge-session">场次匹配: ${p.sessionMatchCount}</span>`;
                        if (p.productMatchCount > 0) matchDetailsHTML += `<span class="match-badge match-badge-product">产品匹配: ${p.productMatchCount}</span>`;
                    }
                    projectRow.innerHTML = `<td>${highlight(p.name, searchTerm)}</td><td>${highlight(p.id, searchTerm)}</td><td>${serialToDate(p.startDate)}</td><td>${serialToDate(p.endDate)}</td><td>${highlight(p.department, searchTerm)}</td><td><span class="status-badge status-${p.status}">${p.status}</span></td><td class="match-details-cell">${matchDetailsHTML}</td>`;
                    ui.tableBody.appendChild(projectRow);
                });
            }
            
            function applyFiltersAndSearch() {
                const searchTerm = ui.searchInput.value.toLowerCase().trim();
                ui.table.classList.toggle('is-searching', !!searchTerm);
                let filteredData = allData;
                if (currentFilter !== 'all') { filteredData = filteredData.filter(p => p.status === currentFilter); }
                if (searchTerm) {
                    const searchRegex = new RegExp(searchTerm.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'gi');
                    const countMatches = (obj) => Object.values(obj).join(' ').toLowerCase().match(searchRegex)?.length || 0;
                    
                    filteredData = filteredData.map(p => {
                        let projectMatchCount = countMatches({ name: p.name, id: p.id, department: p.department, description: p.description });
                        let productMatchCount = p.products.reduce((sum, pr) => sum + countMatches(pr), 0);
                        let sessionMatchCount = p.sessions.reduce((sum, s) => {
                            let count = countMatches({ name: s.name, id: s.id, site: s.site, notes: s.notes });
                            count += s.equipment.reduce((s, item) => s + countMatches(item), 0);
                            count += s.staff.reduce((s, item) => s + countMatches(item), 0);
                            return sum + count;
                        }, 0);
                        
                        return { ...p, projectMatchCount, sessionMatchCount, productMatchCount };
                    }).filter(p => p.projectMatchCount > 0 || p.sessionMatchCount > 0 || p.productMatchCount > 0);
                }
                renderTable(filteredData, searchTerm);
            }
            Object.assign(requestModal, {
                open() { this.reset(); this.populateList(); this.overlay.classList.add('visible'); }, close() { this.overlay.classList.remove('visible'); },
                reset() { this.showPage(1); this.selectedItems = []; this.descriptionText.value = ''; this.categorySelect.value = '服务反馈'; this.nameInput.value = ''; this.idNumberInput.value = ''; this.classDeptInput.value = ''; this.continueBtn.disabled = true; this.submitBtn.disabled = true; this.selectionList.innerHTML = ''; },
                showPage(num) { this.page1.classList.toggle('active', num === 1); this.page2.classList.toggle('active', num === 2); this.backBtn.style.display = num === 2 ? 'block' : 'none'; this.continueBtn.style.display = num === 1 ? 'block' : 'none'; this.submitBtn.style.display = num === 2 ? 'block' : 'none'; this.title.textContent = `新增邮件请求 (${num}/2)`; },
                populateList() { let html = ''; allData.forEach(p => { html += `<div class="selection-item selection-item-project"><label><input type="checkbox" data-id="${p.id}" data-parent=""> ${p.name} (${p.id})</label></div>`; p.products.forEach(pr => { html += `<div class="selection-item selection-item-product"><label><input type="checkbox" data-id="${pr.id}" data-parent="${p.id}"> ${pr.name} (${pr.id})</label></div>`; }); p.sessions.forEach(s => { html += `<div class="selection-item selection-item-session"><label><input type="checkbox" data-id="${s.id}" data-parent="${p.id}"> ${s.name} (${s.id})</label></div>`; }); }); this.selectionList.innerHTML = html; },
                generateRequestId() { const d = new Date(); const ts = `${String(d.getFullYear()).slice(-2)}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}${String(d.getSeconds()).padStart(2,'0')}`; return `FED-${ts}${String(Math.floor(Math.random()*9000)+1000)}`; },
                validatePage2() { this.submitBtn.disabled = !(this.nameInput.value.trim() && this.idNumberInput.value.trim() && this.classDeptInput.value.trim()); },
                updateSelectedItems() { this.selectedItems = Array.from(this.selectionList.querySelectorAll('input:checked')).map(cb => ({ id: cb.dataset.id, parent: cb.dataset.parent })); this.continueBtn.disabled = this.selectedItems.length === 0; },
                getSelectedItemsAsText() { return this.selectedItems.map(item => item.parent ? `[${item.parent}]/[${item.id}]` : `[${item.id}]`).join(', '); }
            });
            document.getElementById('new-request-button').addEventListener('click', () => requestModal.overlay.classList.add('visible'));
            requestModal.closeBtn.addEventListener('click', () => requestModal.overlay.classList.remove('visible')); requestModal.backBtn.addEventListener('click', () => requestModal.showPage(1));
            requestModal.selectionList.addEventListener('change', () => requestModal.updateSelectedItems());
            requestModal.continueBtn.addEventListener('click', () => { requestModal.selectedItemInput.value = requestModal.getSelectedItemsAsText(); requestModal.requestIdInput.value = requestModal.generateRequestId(); requestModal.showPage(2); requestModal.validatePage2(); });
            [requestModal.nameInput, requestModal.idNumberInput, requestModal.classDeptInput].forEach(el => el.addEventListener('input', () => requestModal.validatePage2()));
            requestModal.submitBtn.addEventListener('click', () => { const notes = "【重要注意事项】\n- 请勿手动修改邮件中的任何参数和编码，特别是请求单号。\n- 请在发送前再次核对自己提交的信息是否准确。\n- 我们会在下一个工作日尽快答复您的请求。\n- 为避免事件管理混乱，同一个事件请勿重复提交邮件请求。\n\n--- 请求详情 ---\n"; const body = `${notes}\n- 请求人: ${requestModal.nameInput.value}\n- 学号/工号: ${requestModal.idNumberInput.value}\n- 班级/部门: ${requestModal.classDeptInput.value}\n\n- 请求单号: ${requestModal.requestIdInput.value}\n- 关联目标: ${requestModal.selectedItemInput.value}\n- 事件类别: ${requestModal.categorySelect.value}\n\n- 事件描述:\n${requestModal.descriptionText.value}\n`; const subject = `服务请求: [${requestModal.categorySelect.value}] - ${requestModal.requestIdInput.value}`; window.location.href = `mailto:${EMAIL_RECIPIENT}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`; requestModal.overlay.classList.remove('visible'); });
            ui.searchInput.addEventListener('input', applyFiltersAndSearch);
            ui.filterBtns.forEach(btn => btn.addEventListener('click', function() { ui.filterBtns.forEach(b => b.classList.remove('active')); this.classList.add('active'); currentFilter = this.dataset.filter; applyFiltersAndSearch(); }));
            ui.searchButton.addEventListener('click', applyFiltersAndSearch); ui.searchInput.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); applyFiltersAndSearch(); } });
            [ui.projectMatchCheckbox, ui.sessionMatchCheckbox].forEach(cb => cb.addEventListener('change', applyFiltersAndSearch));
            ui.tableBody.addEventListener('click', e => { const row = e.target.closest('.project-row'); if (row) detailsModal.open(row.dataset.id); });
            detailsModal.closeBtn.addEventListener('click', () => detailsModal.close());
            detailsModal.overlay.addEventListener('click', (e) => { if (e.target === detailsModal.overlay) { detailsModal.close(); } });
            detailsModal.printBtn.addEventListener('click', () => {
                if (detailsModal.currentProjectId) {
                    const url = `https://rendering.ksvg.com.cn/progress/?id=${detailsModal.currentProjectId}`;
                    window.location.href = url;
                }
            });
            ui.tableHead.addEventListener('click', e => { const header = e.target.closest('.sortable-header'); if (!header) return; const sortKey = header.dataset.sort; if (currentSort.key === sortKey) { currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc'; } else { currentSort.key = sortKey; currentSort.order = 'asc'; } applyFiltersAndSearch(); });
            loadAllData();
        });
    } catch (e) { console.error("A critical error occurred on the page:", e); document.getElementById('project-table-body').innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 40px; color: red;">页面脚本发生严重错误，请联系管理员。</td></tr>`; }
    </script>
</body>
</html>